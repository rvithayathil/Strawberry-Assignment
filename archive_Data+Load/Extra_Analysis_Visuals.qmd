---
title: "Analysis_Visuals"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
# Load required libraries
library(tidyverse)
library(ggplot2)
library(viridis)
library(scales)
library(maps)
library(patchwork)

# Read the data
strawberry_tox <- read.csv("strawberry_with_toxicity.csv")

# Data preparation
strawberry_tox <- strawberry_tox %>%
  mutate(
    Year = as.numeric(Year),
    Total_Hazards = rowSums(select(., Acute.Toxic, Corrosive, Environmental.Hazard, 
                                    Flammable, Health.Hazard, Irritant), na.rm = TRUE)
  )

# Remove TOTAL rows for cleaner analysis
strawberry_clean <- strawberry_tox %>%
  filter(Domain.Category != "TOTAL")

# ============================================
# 1. TOXICITY HEATMAP BY HERBICIDE
# ============================================
toxicity_matrix <- strawberry_clean %>%
  group_by(Domain.Category) %>%
  summarise(
    Acute.Toxic = max(Acute.Toxic, na.rm = TRUE),
    Corrosive = max(Corrosive, na.rm = TRUE),
    Environmental.Hazard = max(Environmental.Hazard, na.rm = TRUE),
    Flammable = max(Flammable, na.rm = TRUE),
    Health.Hazard = max(Health.Hazard, na.rm = TRUE),
    Irritant = max(Irritant, na.rm = TRUE),
    Total_Apps = sum(as.numeric(gsub(",", "", APPLICATIONS..MEASURED.IN.LB)), na.rm = TRUE)
  ) %>%
  filter(Total_Apps > 0) %>%
  arrange(desc(Total_Apps)) %>%
  head(15)

# Reshape for heatmap
toxicity_long <- toxicity_matrix %>%
  select(-Total_Apps) %>%
  pivot_longer(cols = -Domain.Category, names_to = "Hazard_Type", values_to = "Present")

p1 <- ggplot(toxicity_long, aes(x = Hazard_Type, y = Domain.Category, fill = as.factor(Present))) +
  geom_tile(color = "white", size = 0.5) +
  scale_fill_manual(values = c("0" = "lightgray", "1" = "red3"), 
                    labels = c("No", "Yes"),
                    name = "Hazard Present") +
  labs(title = "Toxicity Profile of Top 15 Herbicides",
       subtitle = "Based on total application volume",
       x = "Hazard Type",
       y = "Herbicide") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 14))

print(p1)
```

You can add options to executable code like this

```{r}
# Data preparation
strawberry_tox <- strawberry_tox %>%
  mutate(
    Year = as.numeric(Year),
    Total_Hazards = rowSums(select(., Acute.Toxic, Corrosive, Environmental.Hazard, 
                                    Flammable, Health.Hazard, Irritant), na.rm = TRUE)
  )

# Remove TOTAL rows for cleaner analysis
strawberry_clean <- strawberry_tox %>%
  filter(Domain.Category != "TOTAL")

# ============================================
# 1. TOXICITY HEATMAP BY HERBICIDE
# ============================================
toxicity_matrix <- strawberry_clean %>%
  group_by(Domain.Category) %>%
  summarise(
    Acute.Toxic = max(Acute.Toxic, na.rm = TRUE),
    Corrosive = max(Corrosive, na.rm = TRUE),
    Environmental.Hazard = max(Environmental.Hazard, na.rm = TRUE),
    Flammable = max(Flammable, na.rm = TRUE),
    Health.Hazard = max(Health.Hazard, na.rm = TRUE),
    Irritant = max(Irritant, na.rm = TRUE),
    Total_Apps = sum(as.numeric(gsub(",", "", APPLICATIONS..MEASURED.IN.LB)), na.rm = TRUE)
  ) %>%
  filter(Total_Apps > 0) %>%
  mutate(Total_Hazards = Acute.Toxic + Corrosive + Environmental.Hazard + 
                         Flammable + Health.Hazard + Irritant) %>%
  arrange(desc(Total_Hazards), desc(Total_Apps)) %>%
  head(15)

# Reshape for heatmap
toxicity_long <- toxicity_matrix %>%
  select(-Total_Apps, -Total_Hazards) %>%
  pivot_longer(cols = -Domain.Category, names_to = "Hazard_Type", values_to = "Present") %>%
  mutate(Domain.Category = factor(Domain.Category, 
                                  levels = rev(unique(toxicity_matrix$Domain.Category))))

p1 <- ggplot(toxicity_long, aes(x = Hazard_Type, y = Domain.Category, fill = as.factor(Present))) +
  geom_tile(color = "white", size = 0.5) +
  scale_fill_manual(values = c("0" = "lightgray", "1" = "red3"), 
                    labels = c("No", "Yes"),
                    name = "Hazard Present") +
  labs(title = "Toxicity Profile of Top 15 Herbicides",
       subtitle = "Based on total application volume",
       x = "Hazard Type",
       y = "Herbicide") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 14))

print(p1)

```

```{r}
# ============================================
# 1. TOXICITY HEATMAP BY HERBICIDE (ALL CHEMICALS)
# ============================================
toxicity_matrix_all <- strawberry_clean %>%
  group_by(Domain.Category) %>%
  summarise(
    Acute.Toxic = max(Acute.Toxic, na.rm = TRUE),
    Corrosive = max(Corrosive, na.rm = TRUE),
    Environmental.Hazard = max(Environmental.Hazard, na.rm = TRUE),
    Flammable = max(Flammable, na.rm = TRUE),
    Health.Hazard = max(Health.Hazard, na.rm = TRUE),
    Irritant = max(Irritant, na.rm = TRUE),
    Total_Apps = sum(as.numeric(gsub(",", "", APPLICATIONS..MEASURED.IN.LB)), na.rm = TRUE)
  ) %>%
  filter(Total_Apps > 0) %>%
  mutate(Total_Hazards = Acute.Toxic + Corrosive + Environmental.Hazard + 
                         Flammable + Health.Hazard + Irritant) %>%
  arrange(desc(Total_Hazards), desc(Total_Apps))

# Reshape for heatmap
toxicity_long_all <- toxicity_matrix_all %>%
  select(-Total_Apps, -Total_Hazards) %>%
  pivot_longer(cols = -Domain.Category, names_to = "Hazard_Type", values_to = "Present") %>%
  mutate(Domain.Category = factor(Domain.Category, 
                                  levels = rev(unique(toxicity_matrix_all$Domain.Category))))

p1 <- ggplot(toxicity_long_all, aes(x = Hazard_Type, y = Domain.Category, fill = as.factor(Present))) +
  geom_tile(color = "white", size = 0.5) +
  scale_fill_manual(values = c("0" = "lightgray", "1" = "red3"), 
                    labels = c("No", "Yes"),
                    name = "Hazard Present") +
  labs(title = "Toxicity Profile of All Herbicides Used in Strawberry Production",
       subtitle = "Ordered by number of hazard categories (most toxic at top)",
       x = "Hazard Type",
       y = "Herbicide") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8),
        plot.title = element_text(face = "bold", size = 14))

print(p1)
```

```{r}
# ============================================
# 2. TIME SERIES: HERBICIDE USAGE OVER YEARS
# ============================================
yearly_usage <- strawberry_clean %>%
  mutate(LBS = as.numeric(gsub(",", "", APPLICATIONS..MEASURED.IN.LB))) %>%
  filter(!is.na(LBS)) %>%
  group_by(Year, State) %>%
  summarise(Total_LBS = sum(LBS, na.rm = TRUE), .groups = "drop")

p2 <- ggplot(yearly_usage, aes(x = Year, y = Total_LBS, color = State)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(1990, 2025, 2)) +
  labs(title = "Herbicide Usage Trends by State (1990-2023)",
       x = "Year",
       y = "Total Pounds Applied",
       color = "State") +
  theme_minimal() +
  theme(legend.position = "right",
        plot.title = element_text(face = "bold", size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p2)
```

```{r}
# ============================================
# 3. TOP 10 MOST USED HERBICIDES
# ============================================
top_herbicides <- strawberry_clean %>%
  mutate(LBS = as.numeric(gsub(",", "", APPLICATIONS..MEASURED.IN.LB))) %>%
  filter(!is.na(LBS)) %>%
  group_by(Domain.Category) %>%
  summarise(Total_LBS = sum(LBS, na.rm = TRUE),
            Total_Hazards = first(Total_Hazards)) %>%
  arrange(desc(Total_LBS)) %>%
  head(10)

p3 <- ggplot(top_herbicides, aes(x = reorder(Domain.Category, Total_LBS), 
                                  y = Total_LBS, 
                                  fill = Total_Hazards)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  scale_fill_viridis(option = "plasma", direction = -1, name = "Number of\nHazard Types") +
  labs(title = "Top 10 Most Used Herbicides (All Years Combined)",
       subtitle = "Color indicates number of toxicity hazards",
       x = "Herbicide",
       y = "Total Pounds Applied") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))

print(p3)
```

```{r}
# ============================================
# 4. HAZARD TYPE DISTRIBUTION (BAR CHART)
# ============================================
hazard_summary <- strawberry_clean %>%
  summarise(
    `Acute Toxic` = sum(Acute.Toxic, na.rm = TRUE),
    Corrosive = sum(Corrosive, na.rm = TRUE),
    `Environmental Hazard` = sum(Environmental.Hazard, na.rm = TRUE),
    Flammable = sum(Flammable, na.rm = TRUE),
    `Health Hazard` = sum(Health.Hazard, na.rm = TRUE),
    Irritant = sum(Irritant, na.rm = TRUE)
  ) %>%
  pivot_longer(everything(), names_to = "Hazard", values_to = "Count") %>%
  mutate(Percentage = (Count / sum(Count)) * 100) %>%
  arrange(desc(Percentage))

p4 <- ggplot(hazard_summary, aes(x = reorder(Hazard, Percentage), y = Percentage, fill = Hazard)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), hjust = -0.2, size = 4, fontface = "bold") +
  coord_flip() +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(labels = function(x) paste0(x, "%"), limits = c(0, max(hazard_summary$Percentage) * 1.1)) +
  labs(title = "Distribution of Hazard Types Across All Herbicide Applications",
       subtitle = "Percentage of total hazard occurrences",
       x = "Hazard Type",
       y = "Percentage of Occurrences") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        panel.grid.major.y = element_blank())

print(p4)
```

```{r}
# ============================================
# 5. STATE COMPARISON: TREATMENT COVERAGE
# ============================================
state_coverage <- strawberry_clean %>%
  mutate(Pct_Treated = as.numeric(TREATED..MEASURED.IN.PCT.OF.AREA.BEARING..AVG)) %>%
  filter(!is.na(Pct_Treated)) %>%
  group_by(State) %>%
  summarise(Avg_Coverage = mean(Pct_Treated, na.rm = TRUE)) %>%
  arrange(desc(Avg_Coverage))

p5 <- ggplot(state_coverage, aes(x = reorder(State, Avg_Coverage), y = Avg_Coverage)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Average Percentage of Strawberry Area Treated by State",
       x = "State",
       y = "Average % of Area Treated") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))

print(p5)
```
