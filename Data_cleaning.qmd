---
title: "assignment-615-cleaning-data"
format: html
editor: visual
---

```{r Libraries}
library(tidyverse)
```

## Data Load

```{r Load Data}
Strawberry <- read.csv("https://raw.githubusercontent.com/rvithayathil/Strawberry-Assignment/refs/heads/Data/USDA_Herbicide_Raw_Data.csv")
glimpse(Strawberry)

```

## Data Cleaning

```{r Drop Cols}
## Create Function remove columns with a single value in all rows
drop_one_value_col <- function(df) {
  keep <- vapply(df, function(x) dplyr::n_distinct(x, na.rm = FALSE) > 1, logical(1))
  df[, keep, drop = FALSE]
}

Strawberry_clean <- drop_one_value_col(Strawberry)

Strawberry_clean$Domain.Category <- trimws(sub(".*:", "", Strawberry_clean$Domain.Category))
Strawberry_clean$Data.Item       <- trimws(sub(".*-", "", Strawberry_clean$Data.Item))
Strawberry_clean$Value <- ifelse(Strawberry_clean$Value %in% c(" (NA)"), NA, Strawberry_clean$Value)

# Filter for rows with Herbicide Information
Strawberry_clean <- Strawberry_clean %>%
  filter(grepl("HERB", Domain, ignore.case = TRUE)) %>%
  mutate(Domain = str_c(Domain, Domain.Category, sep = ": ")) %>%
  select(-Domain.Category)

Strawberry_clean <- Strawberry_clean %>%
  group_by(Program, Year, State, Domain, Data.Item) %>%
  summarise(Value = max(Value, na.rm = TRUE), .groups = "drop")

# Change Data Format
strawberry_wide <- Strawberry_clean %>%
  tidyr::pivot_wider(
    id_cols = c(Program, Year, State, Domain),
    names_from = Data.Item,
    values_from = Value
  )
head(Strawberry)
# Count the number of rows
num_rows <- nrow(Strawberry)
# Print the result
cat("# of Rows Strawberry:", num_rows, "\n")

head(Strawberry_clean)
# Count the number of rows
num_rows <- nrow(Strawberry_clean)
# Print the result
cat("# of Rows Strawberry_clean:", num_rows, "\n")

head(strawberry_wide)
# Count the number of rows
num_rows <- nrow(strawberry_wide)
# Print the result
cat("# of Rows strawberry_wide:", num_rows, "\n")


```

```{r}
Strawberry_clean1$Domain.Category <- trimws(sub(".*:", "", Strawberry_clean1$Domain.Category))
Strawberry_clean1$Data.Item <- trimws(sub(".*-", "", Strawberry_clean1$Data.Item))
Strawberry_clean1$Value <- ifelse(Strawberry_clean1$Value %in% c(" (NA)"),
                                  NA,Strawberry_clean1$Value)
Strawberry_clean2<- Strawberry_clean1 %>%
  filter(grepl("HERB", Domain, ignore.case = TRUE))

Strawberry_clean2 <- Strawberry_clean2 %>%
  mutate(Domain = str_c(Domain, Domain.Category, sep = ": ")) %>%
  select(-Domain.Category)
```

```{r}
Strawberry_clean2 %>%
  group_by(Program, Year, State, Domain, Data.Item) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

Strawberry_clean2_summarised <- Strawberry_clean2 %>%
  group_by(Program, Year, State, Domain, Data.Item) %>%
  summarise(Value = max(Value, na.rm = TRUE), .groups = "drop")

strawberry_wide <- Strawberry_clean2_summarised %>%
  pivot_wider(
    id_cols = c(Program, Year, State, Domain),
    names_from = Data.Item,
    values_from = Value)
```

```{r}
## Keep ONLY years with BOTH Herbicide & Organic data (1990+)
states_both <- tibble(Year = 1990:max(as.integer(c(strawberry_wide$Year, Strawberry$Year)), na.rm = TRUE)) %>%
  left_join(
    strawberry_wide %>%
      mutate(Year = suppressWarnings(as.integer(Year))) %>%
      filter(!is.na(Year), nzchar(State)) %>%
      group_by(Year) %>% summarise(h = list(sort(unique(State))), .groups = "drop"),
    by = "Year"
  ) %>%
  left_join(
    Strawberry %>%
      filter(grepl("ORGANIC STATUS", Domain, ignore.case = TRUE)) %>%
      mutate(Year = suppressWarnings(as.integer(Year))) %>%
      filter(!is.na(Year), nzchar(State)) %>%
      group_by(Year) %>% summarise(o = list(sort(unique(State))), .groups = "drop"),
    by = "Year"
  ) %>%
  mutate(both = purrr::map2(h, o, ~{
    a <- if (is.null(.x)) character(0) else .x
    b <- if (is.null(.y)) character(0) else .y
    sort(intersect(a, b))
  })) %>%
  filter(lengths(both) > 0) %>%
  transmute(
    Year,
    `States with both` = purrr::map_chr(both, ~ paste(.x, collapse = ", "))
  ) %>%
  arrange(Year)

states_both
```
